#! /bin/sh

export SRC_ROOT="/local/scale-product"
export TARGETDIR='obj/generic'
export MAKEFLAGS="-j$(expr $(nproc) \- 1)"
export TRACE_FLAGS=--coverage
export BUILD_TYPE=debug
# OPTIONAL BUILD_ROOT forces build to run make from $BUILD_ROOT


init_mezzanine ()
{
    buildID="$1";
    testbeds="$2";
    if [ "x$buildID" = "x" ] || [ "x$testbeds" = "x" ]; then
        echo "Error: missing arguments"
        echo "Expected: \"buildID\" \"testbeds\""
        return 1
    fi
    cd "/builds/automated/$buildID/src/daemons/scqad/" &&
        "$(make -s echo_targetdir)/scqadleader" -s -b $testbeds 'installSCQADOnCluster {}; configureClusters {}'
    return $?
}


# copy local changes to buildvm source copy
scrsync ()
{
    CODE_DIR="$HOME/git/scale-product"
    rsync -avzh -e ssh --exclude-from="$HOME/.gitignore_global" --exclude-from="$CODE_DIR/.gitignore" $CODE_DIR/* buildvm:$SRC_ROOT
}


# ssh into buildvm and launch scmake in a screen session
# some cool things this lets me do
#   - If I lose connectivity my build isnt killed
#   - If I want to detach I can just ctrl-a d and ill end up back in the local terminal session
#   - If I run this while another build is in session it reattaches the existing build rather than starting a new one
rscmake ()
{
    if [ "x$BUILD_ROOT" = "x" ]; then
        BUILD_ROOT="$SRC_ROOT"
    fi
    # -m forces a new session to be created
    # ssh -t buildvm screen -dRR -s bash -S build "bash -c \"echo hi; source ~/.bash_profile; scmake\""
    ssh -t buildvm screen -dRR -S build "bash -c \"echo hi; source ~/.bash_profile; cd $BUILD_ROOT; scmake $@\""
}


# call make on local build directory and log output
scmake ()
{
    if [ "x$1" != "x" ]; then
        TARGET_NAME="all"
    else
        TARGET_NAME="$1"
    fi

    # If were not in a subdirectory of the project root then run command from
    # project root
    if [ "x$BUILD_ROOT" != "x" ]; then
        cd $BUILD_ROOT
    elif [ "${PWD##$SRC_ROOT}" == "${PWD}" ]; then
        cd $SRC_ROOT
    fi

    DIRNAME=${basename ${PWD}}
    LOGFILE="$SRC_ROOT/$DIRNAME-$TARGET_NAME.make.txt"

    echo -e "\n>>>>>>>> \e[94mStarting\e[0m <<<<<<<<"
    echo -e ">> Compiling ${PWD}\n"

    #output stderr and stdout to $LOGFILE and stderr to screen
    make "$@" 2>&1 \
     | tee "$LOGFILE"  \
     | grep --color -P "error|"

    if [ $? -eq 0 ]; then
        echo -e "\n>>>>>>>> \e[92mDone\e[0m <<<<<<<<"
    else
        echo -e "\n>>>>>>>> \e[91mKilled\e[0m <<<<<<<<"
    fi
}
